@use "sass:math";

@import 'variables/variables';

@import 'mixins/mixins';

@import 'lib/leaflet/index';

@import 'leaflet.locatecontrol/src/L.Control.Locate';
@import 'leaflet-control-geocoder/dist/Control.Geocoder';


[data-map="leaflet"] {
	width: 100%;
}

.leaflet-map {
	user-select: none;
	.block-editor__container & {
		width: 100%;
		.leaflet-top,
		.leaflet-bottom {
			/* .editor-block-toolbar: 101 */
			z-index: 80;
		}
	}
	&[data-can-add-marker="false"] ~ .markers-instruction {
		.can-add-marker {
			display: none;
		}
	}
	&[data-has-markers="false"] ~ .markers-instruction {
		.has-markers {
			display: none;
		}
	}
	&.add-marker-on-taphold ~ .markers-instruction .marker-on-dblclick {
		display: none;
	}
	&.add-marker-on-dblclick ~ .markers-instruction .marker-on-taphold {
		display: none;
	}
}
.acf-block-preview {
	iframe[src*="openstreetmap.org"] {
		pointer-events: none;
	}
}

.acf-field-open-street-map {
	.acf-osm-map {
		width: 100%;
		height: 400px;
	}
	input[type="search"][data-prop="address"] {
		font-size: 20px;
		font-weight: 300;
		letter-spacing: 0.03em;
		color: $wp-gray-darker;
	}
}

.osm-markers {
	.osm-marker {
		position: relative;
		display: flex;
		align-items: center;
		padding: 0.25em 0;
		border-bottom: 1px solid $wp-gray;
		&:nth-of-type(2n) {
			background-color: $wp-gray-lightest;
		}
		&.focus {
			background-color: rgba($wp-yellow,0.5);
		}
		& > .locate {
			&.dashicons {
				&,
				&::before {
					font-size: 32px;
					cursor: pointer;
				}
			}
		}
		& > .tools,
		& > .locate {
			flex: 0;
			min-width: 32px;
			text-align: center;
		}
		& > .input {
			flex: 1;
		}
		input[type="text"] {
			width: 100%;
			font-size: 20px;
			font-weight: 300;
		}
		a.acf-icon.light {
			border: 1px solid $wp-gray-dark;
		}
	}
	[data-id="__osm_marker_template__"] {
		display: none;
	}
}

@keyframes pling {
	0% { left: 0;top: 0;width: 12px;height: 12px; opacity: 0; }
	5% { opacity: 1 }
	80% { opacity: 1 }
	100% { left: -25px;top: -25px;width: 62px;height: 62px; opacity: 0; }
}

.osm-marker-icon {
	//border:1px solid $wp-red;
	border-radius:50%;
	// position:relative;
	// triangle
	&:before {
		content: '';
		border-style: solid;
		border-color: $wp-blue transparent transparent transparent;
		border-width: 20px 12px 0 12px;
		position: absolute;
		left: -6px; // -12
		top: -14px; // -20
		z-index: 1;
	}
	$size:26px;
	// circle
	&:after {
		content: '';
		clip: rect(0,0,100%,100%);
		width: $size;
		height: $size;
		border-radius:  math.div( $size, 2 );
		background-color: #fff;
		border: 8px solid $wp-blue;
		box-sizing: border-box;
		position: absolute;
		bottom: 18px; // 24
		left: math.div( - $size , 2) + 6px;
	}
	&.focus,
	&:focus {
		&:before {
			// border-top-color:$wp-blue-light;
		}
		&:after {
			// border-color:$wp-blue-light;
			// background-color:$wp-blue-lighter;
			box-shadow: 0 0 6px 12px rgba( $wp-yellow, 0.75 );
		}
	}
	&:hover {
		&:before {
			border-top-color: $wp-red;
		}
		&:after {
			content: $dashicon-no;
			font-family: 'dashicons';
			color: #fff;
			font-size: $size;
			line-height: $size + 1;
			border-color: $wp-red;
			background-color: $wp-red;
			border-width: 0;
			z-index: 2;
		}
	}
	.pling {
		// box-shadow: inset 0 0 2px $wp-blue,
		// 			0 0 2px $wp-blue;
		position: absolute;
		opacity: 0;
		border: 4px solid $wp-blue;
		@media screen and (min-width: 768px) {
			border-width: 2px;
		}
		border-radius: 50%;

		animation-name: pling;
		animation-duration: 0.75s;
		animation-iteration-count: 1;
		animation-timing-function: ease-in;
	}
}

.acf-osm-above {
	position: relative;
	z-index: 2;
	& + .leaflet-map {
		z-index: 1;
	}
	.leaflet-control-geocoder {
		// height: 38px;
		display: flex;
		width: 100%;
		box-shadow: none;
		padding: 5px 0;
		box-sizing: border-box;
		& > .leaflet-control-geocoder-icon,
		& > .leaflet-control-geocoder-form {
			border-radius: none;
		}

		& > .leaflet-control-geocoder-icon {
			flex: 0;
			min-width: 42px;
			height: 38px;
			order: 2;
			background-color: $wp-blue;
			background-image: none;
			border-radius: 0 4px 4px 0;
			&:before {
				content: $dashicon-search;
				font-family: 'dashicons';
				color: #fff;
				font-size: 20px;
			}
		}
		& > .leaflet-control-geocoder-form {
			flex: 1;
			order: 1;
			input {
				padding: 0.25em 1em;
				font-size: 20px;
				line-height: 1.3;
				font-weight: 300;
				border: 1px solid #8c8f94;
				border-top-right-radius: 0;
				border-bottom-right-radius: 0;
			}
		}
		& > .leaflet-control-geocoder-error,
		& > .leaflet-control-geocoder-alternatives {
			margin: 0;
			position: absolute;
			left: 0.5em;
			top: calc(100% + 0.5em);
			background: #fff;
			max-height: calc( var(--map-height,400) * 1px - 1em );
			overflow: auto;
		}
		& > .leaflet-control-geocoder-error {
			padding: 0.5em 1em;
		}
		& > .leaflet-control-geocoder-alternatives {
		}
	}
	&:has(.leaflet-control-geocoder-alternatives) {

	}
}

$leaflet-panes: (
	// original
	leaflet-pane:400,
	leaflet-tile-pane: 200,
	leaflet-shadow-pane: 500,
	leaflet-overlay-pane: 400,
	leaflet-marker-pane: 600,
	leaflet-tooltip-pane: 650,
	leaflet-popup-pane: 700,
);

.wp-block {
	@each $pane,$zindex in $leaflet-panes {

		.#{$pane} {
			z-index: math.div( $zindex, 10);
		}
	}
}

// block editor fixes
.leaflet-pane {
	.postbox &,
	.components-panel &, // block editor
	.wp-block & {
		z-index: 30;
	}

}
.leaflet-control-container {
	a {
		-webkit-touch-callout: none; /* iOS Safari */
	  -webkit-user-select: none; /* Safari */
	   -khtml-user-select: none; /* Konqueror HTML */
		 -moz-user-select: none; /* Old versions of Firefox */
		  -ms-user-select: none; /* Internet Explorer/Edge */
			  user-select: none; /* Non-prefixed version, currently
									supported by Chrome, Opera and Firefox */
	}
}
.leaflet-control-layers {
	.wp-block & {
		text-align: left;
	}
}

.leaflet-control-layers-scrollbar {
	overscroll-behavior: contain;
}

@keyframes following {
	from { color: $wp-blue }
	to { color: mix($wp-blue-light,$wp-blue-lighter) }
}

.leaflet-control {
	a {
		.dashicons {
			line-height: 30px;
		}
	}
}

.leaflet-control-locate {
	& + .leaflet-control-add-location-marker {
		display: none;
		border-top-left-radius: 0;
		border-top-right-radius: 0;
		border-top-width: 0 !important;
		margin-top: -10px !important;
	}
	&.active {
		[data-can-add-marker="true"] & {
			.dashicons-location-alt {
				position: relative;
				&::before {
					content: $dashicon-location;
				}
			}
			border-bottom-left-radius: 0;
			border-bottom-right-radius: 0;
			& + .leaflet-control-add-location-marker {
				display: block;
			}
		}
	}
	&:not(.active):not(.following) {
		.dashicons:not(.dashicons-warning) {
			border-radius: 50%;
			outline: 1px solid currentcolor;
			outline-offset: -3px;
			border-image: conic-gradient( currentcolor 6deg, transparent 6deg 90deg, currentcolor 90deg 96deg, transparent 96deg 180deg, currentcolor 180deg 186deg, transparent 186deg 270deg, currentcolor 270deg 276deg, transparent 276deg );
			border-width: 0.5em;
			border-style: solid;
			box-sizing: border-box;
			border-image-repeat: stretch;
			border-image-slice: 50%;
			transform: rotate(-3deg);
			margin-top: 5px;
			// background: radial-gradient( #ffff 10%, #fff0 10%, #0000 60%, #000f 60%, #000f 70%, #0000 70% );
			&::before {
				// content: "\f543"; /* plus-alt2 */
				color: transparent;
			}
		}
	}
	&.following {
		.dashicons {
			color: $wp-blue-lighter;
			animation-name: following;
			animation-duration: 2s;
			animation-iteration-count: infinite;
			animation-direction: alternate;
		}
	}
	a {
		.dashicons-warning {
			color: $wp-red;
		}
		.spinner {
			float:none;
			margin: -3px 0 0 0;
		}
	}
}
.leaflet-control-add-location-marker {
	.dashicons {
		&::before {
			line-height: 30px;
			font-size: 18px;
		}
		&::after {
			content: $dashicon-plus;
			font-size: 13px;
			position: absolute;
			top: -6px;
			right: 0;
		}
	}
}
